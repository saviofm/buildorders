const cds = require('@sap/cds/lib')

const addExtension = require('./extensibility/addExtension')
const { add, set_, promote } = require('./extensibility/add')
const { push, pull } = require('./extensibility/push')
const token = require('./extensibility/token')
const { transformExtendedFieldsCREATE, transformExtendedFieldsUPDATE } = require('./extensibility/handler/transformWRITE')
const { transformExtendedFieldsREAD } = require('./extensibility/handler/transformREAD')
const { transformExtendedFieldsRESULT } = require('./extensibility/handler/transformRESULT')
const { addCodeAnnotations } = require('./extensibility/code-extensibility/addCodeAnnotLocal')

module.exports = class ExtensibilityService extends cds.ApplicationService {

  async init() {
    this.on('addExtension', addExtension)
    this.on('add', add)
    this.on('set', set_)
    this.on('promote', promote)
    this.on('push', push)
    this.on('pull', pull)

    // REVISIT: adapt flags for side-car: use main
    const _in_prod = process.env.NODE_ENV === 'production'
    if (cds.env.requires.extensibility?.code && !_in_prod && !cds.requires.multitenancy) {
      const findings = await addCodeAnnotations()
      if (findings?.length > 0) {
        let message = `Code validation failed with ${findings.length} finding(s):\n\n`
        message += findings.join('\n')
        throw new Error(message)
      }
    }

    cds.on('served', () => {
      if (cds.app) {
        cds.app.post('/-/cds/login/token', token)
        cds.app.get('/-/cds/login/token', token)
      }
    })

    const { 'cds.xt.ModelProviderService': mps } = cds.services
    if (!mps?._in_sidecar && cds.db?.model)
      cds.db
        .before('CREATE', transformExtendedFieldsCREATE)
        .before('UPDATE', transformExtendedFieldsUPDATE)
        .before('READ', transformExtendedFieldsREAD)
        .after('READ', transformExtendedFieldsRESULT)

    return super.init()
  }
}
