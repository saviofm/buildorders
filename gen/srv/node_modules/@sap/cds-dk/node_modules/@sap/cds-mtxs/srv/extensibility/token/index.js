const util = require('util');
const cds = require('@sap/cds/lib');
const { getAuthProvider } = require('./authProvider/AuthProviderFactory');

const LOG = cds.log('mtx');
const DEBUG = cds.debug('mtx');

async function parseBody(request) {
    return new Promise((resolve, reject) => {
        const chunks = [];
        request.on('data', chunk => chunks.push(chunk));
        request.on('end', () => {
            try {
                const body = Buffer.concat(chunks).toString();
                request.body = Object.fromEntries(new URLSearchParams(body).entries());
                resolve(request.body);
            } catch (error) {
                reject(error);
            }
        });
    });
}

module.exports = async function token(request, response) {
    if (request.method === 'HEAD') {
        return response.status(204).send();
    }

    LOG.info(`Getting auth token`);

    const { credentials } = cds.env.requires.auth;
    const query = request.method === 'POST'
        ? await parseBody(request)
        : request.query;

    let authProvider;
    try {
        authProvider = getAuthProvider(credentials, query);
    } catch (error) {
        LOG.error(error);
        return response.status(500).send(error);
    }

    try {
        const { data } = await require('axios').post(
            authProvider.authUrl,
            authProvider.postData,
            {
                ...authProvider.clientAuth,
                timeout: 1e4 // ms
            }
        );
        response.status(200).send(data);

    } catch (axError) {
        const code = axError.code ? `${axError.code}. ` : '';
        const data = axError.response?.data;
        const reason = data?.error /* RFC 6749 */ ?? axError.message;
        const passcodeUrl = new URL(authProvider.authUrl);
        passcodeUrl.pathname = '/passcode';

        let details = '';
        if (data) {
            details += `Details: '${data.error_description /* RFC 6749 */ || util.inspect(data)}'. `;
        }
        if (axError.response?.status === 401) {
            details += `Client authentication: ${authProvider.clientAuthToLog()}. `;
        }
        details += `POST data: '${authProvider.postDataToLog()}'. `;

        const toLog = `Authentication failed: ${code}${reason}. ${details}Passcode URL: ${passcodeUrl}`;
        const toSend = `Authentication failed: ${code}${reason}. Passcode URL: ${passcodeUrl}`;

        const status = axError.response?.status ?? 500;

        LOG.error(toLog);
        DEBUG && LOG.error(axError);
        response.status(status).send(toSend);
    }
}
