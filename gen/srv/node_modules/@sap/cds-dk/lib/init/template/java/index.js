const os = require('os')
const cds = require('../../../cds')
const { exists, copy, rimraf, fs, path } = cds.utils, { join } = path
const cmd = require('../../../util/command')
const mvn = require('../../util/mvn')
const term = require('../../../util/term')
const { URLS, OPTIONS: { NODEJS, JAVA }, COMMAND_ADD } = require('../../constants')

module.exports = class JavaTemplate extends require('../templateBase') {

    static hasFacet() {
        return exists('pom.xml') || cds.cli.options?.add?.has(JAVA)
    }

    async canRun() {
        if (cds.cli.command === COMMAND_ADD) {
            throw `You can't change the runtime of an existing project.`
        }
        if (cds.cli.options.add?.has(NODEJS)) {
            throw `Only one runtime per project is supported. Specify either ${term.bold(JAVA)} or ${term.bold(NODEJS)}.`
        }
        return true
    }

    async run() {
        const { cmdLine, artifactId, archetypeVersion } = await mvn.getGenerateCmdArgs(this.projectName, this.options)
        console.log(`Using Maven archetype version ${archetypeVersion}`)

        const temp = await fs.promises.mkdtemp(join(os.tmpdir(), `${this.projectName}_`))
        try {
            await cmd.spawnCommand('mvn', cmdLine, { cwd: temp })
            await copy(join(temp, artifactId), this.projectPath);
        } catch (err) {
            if (err.code === 'ENOENT' && err.path === 'mvn') {
                throw `Maven executable 'mvn' not found, follow ${term.info(URLS.MAVEN_INSTALL_HELP)} and install Maven on your machine.`
            }
            throw err;
        } finally {
            await rimraf(temp);
        }
    }

    async finalize() {
        console.log(`Learn about next steps at ${term.link(URLS.CAPIRE)}`)
    }
}
