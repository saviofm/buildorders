const cds = require('../../../cds')
const { exists } = cds.utils
const { join } = require('path')
const { readProject } = require('../../util/projectReader')
const { mergeJSON } = require('../../util/merge')
const { MULTITENANCY } = require('../../constants').OPTIONS

module.exports = class ExtensibilityTemplate extends require('../templateBase') {


  getDependencies() {
    return exists('pom.xml') ? [MULTITENANCY] : [] // REVISIT: Remove this dependency
  }

  getRelatedFacets() {
    return ['approuter']
  }

  static hasFacet(env) {
    return !!env.requires?.extensibility
  }

  async run() {
    const project = await readProject(this.options)
    const { configFile } = project
    await mergeJSON(configFile, join(__dirname, 'files', 'package.json.hbs'), project)
    await this.runDependentMerging()
  }

  async runDependentMerging() {
    const project = await readProject(this.options)
    const { hasXsuaa } = project
    if (hasXsuaa) {
      await mergeJSON(
        'xs-security.json',
        join(__dirname, 'files', 'xs-security.json.hbs'),
        project,
        {
          additions: [{
            in: 'scopes',
            where: [{ property: 'name', isEqualTo: '$XSAPPNAME.cds.ExtensionDeveloper' }],
          }, {
            in: 'scopes',
            where: [{ property: 'name', isEqualTo: '$XSAPPNAME.cds.UIFlexDeveloper' }],
          }, {
            in: 'role-templates',
            where: [{ property: 'name', isEqualTo: 'ExtensionDeveloper' }],
          }]
        }
      )
    }
  }
}
