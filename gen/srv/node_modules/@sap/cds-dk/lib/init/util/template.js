const Mustache = require('mustache')
const { copy, read, write, exists, readdir, path, isdir } = require('../../cds').utils

async function copyFiles(templatePath, destinationPath, templateValues, overwrite = false) {
    for (const dirent of await readdir(templatePath)) {
        const fileNew = Mustache.render(dirent, templateValues)
        const src = path.join(templatePath, dirent);
        const dest = path.join(destinationPath, fileNew);

        if (isdir(src)) {
            await copyFiles(path.join(templatePath, dirent), dest, templateValues, overwrite);
        } else if (path.extname(dirent) === '.hbs') {
            const destinationPath = dest.replace('.hbs', '');
            if (overwrite || !exists(destinationPath)) {
                const content = await render(src, templateValues);
                await write(destinationPath, content, { spaces: 2 });
            }
        } else {
            await copy(src, dest);
        }
    }
}

async function render(src, templateValues) {
    const content = await read(src, 'utf-8');
    return Mustache.render(content, templateValues);
}

module.exports = {
    render,
    copyFiles
}
