const { join } = require('path')

function _oldMtx(cds = require('../cds')) {
    function _hasMtxDependency() {
        try {
            return require(join(cds.root, 'package.json'))?.dependencies?.['@sap/cds-mtx']
        } catch(e) {
            return false
        }
    }
    return (_hasMtxDependency() || process.env.OLD_MTX?.toLowerCase() === 'true') ?? false
}

function checkMtx(cds) {
    if (_oldMtx(cds)) {
        const { CliError } = require('../client/helper/errors')
        throw new CliError(`Package @sap/cds-mtx is deprecated and incompatible with @sap/cds-dk >= 7.
To continue using it, install version 6 of @sap/cds-dk in your project with:
  npm i @sap/cds-dk@6
However, it is RECOMMENDED to migrate to @sap/cds-mtxs instead.
See https://cap.cloud.sap/docs/guides/multitenancy/old-mtx-migration for more.`)
    }
}

module.exports = {
    checkMtx
}
