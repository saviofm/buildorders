const GraphQLAdapter = require('@cap-js/graphql') // eslint-disable-line cds/no-missing-dependencies
const express = require ('express') // eslint-disable-line cds/no-missing-dependencies

function CDSGraphQLAdapter (options) {
  const { services } = options

  return express.Router()
  .use (express.json()) //> required in the slug handlers and logger below

  // convenience slug route for /graphql/srv/entity/id
  .use ('/:path/:entity/:id?(%20:query)?', (req, _, next) => {
    // TODO: add filter by id -> then remove the // eslint-disable-line
    const { entity, query } = req.params // eslint-disable-line no-unused-vars
    if (query) req.body = { query }
    if (entity) req.body.query = req.body.query.replace(/{/, `{ ${entity} {`) +'}'
    next() //> goes on below
  })

  // convenience slug route for /graphql/srv
  .use ('/:path', (req, res, next) => {
    const srv = services [req.params.path]
    if (req.body) req.body.query = req.body.query.replace(/{/, `{ ${srv.name} {`) +'}'
    next() //> goes on below
  })

  // the global /graphql route
  .use (new GraphQLAdapter (options))
}

module.exports = CDSGraphQLAdapter
